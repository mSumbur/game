var container=document.getElementById("game");var enemyANimation;var level;var score;var CONFIG={status:"start",level:1,totalLevel:6,numPerLine:7,canvasPadding:30,bulletSize:10,bulletSpeed:10,enemySpeed:2,enemySize:50,enemyGap:10,enemyIcon:"img/enemy.png",enemyBoomIcon:"img/boom.png",enemyDirection:"right",enemyArea:{width:640,height:440},planeSpeed:5,planeSize:{width:60,height:100},planeIcon:"./img/plane.png"};var GAME={init:function(opts){this.status="start";this.bindEvent()},bindEvent:function(){var self=this;document.addEventListener("click",function(event){var target=event.target;if(target.classList.contains("js-replay")||target.classList.contains("js-play")){level=1;score=0;self.play()}else if(target.classList.contains("js-next")){if(GAMEUI.level<CONFIG.totalLevel){level++}self.play()}});document.addEventListener("keydown",function(event){if(GAME.status==="playing"){var code=event.keyCode;switch(code){case 32:fire();break;case 37:GAMEUI.planeX-=CONFIG.planeSpeed;break;case 39:GAMEUI.planeX+=CONFIG.planeSpeed;break}}})},setStatus:function(status){this.status=status;container.setAttribute("data-status",status)},play:function(){GAMEUI.init();enemyAnimation=requestAnimationFrame(animate);this.setStatus("playing")},failed:function(){this.setStatus("failed");var scoreNode=document.querySelector(".score");scoreNode.innerText=score;this.gameFinish()},success:function(){this.setStatus("success");var levelNode=document.querySelector(".game-next-level");levelNode.innerText="下一个Level: "+(level+1);this.gameFinish()},allSuccess:function(){this.setStatus("all-success");this.gameFinish()},gameFinish:function(){cancelAnimationFrame(enemyAnimation);GAMEUI.clearUI()}};var canvas=document.getElementById("canvas");var context=canvas.getContext("2d");var GAMEUI={init:function(){this.level=level;this.x=CONFIG.canvasPadding;this.y=this.x;this.enemyArr=[];for(var i=0;i<this.level;i++){this.enemyArr[i]=[];for(var j=0;j<CONFIG.numPerLine;j++){this.enemyArr[i][j]={x:0,y:0,isAlive:1,boomIndex:0}}}this.enemyDirection=CONFIG.enemyDirection;this.enemy=new Image;this.enemy.src=CONFIG.enemyIcon;this.enemyBoom=new Image;this.enemyBoom.src=CONFIG.enemyBoomIcon;this.plane=new Image;this.plane.src=CONFIG.planeIcon;this.planeX=canvas.width/2-CONFIG.planeSize.width/2;this.planeY=canvas.height-CONFIG.canvasPadding-CONFIG.planeSize.height;this.plane.onload=function(){GAMEUI.drawPlane()};this.enemyBoom.onload=function(){console.log("load")};this.score=0;context.font="18px sans-serif";context.fillStyle="#fff"},drawEnemy:function(){var x=this.x;var y=this.y;var size=CONFIG.enemySize;for(var i=0;i<level;i++){this.enemyArr[i].forEach(function(item){if(item.isAlive){context.drawImage(GAMEUI.enemy,x,y,size,size);item.x=x;item.y=y}else if(item.boomIndex&&item.boomIndex<=3){context.drawImage(GAMEUI.enemyBoom,x,y,size,size);item.boomIndex++}x+=60});x=this.x;y+=50}},drawPlane:function(){var plane=this.plane;if(this.planeX>670-60){this.planeX=670-60}else if(this.planeX<30){this.planeX=30}context.drawImage(plane,this.planeX,this.planeY,CONFIG.planeSize.width,CONFIG.planeSize.height)},drawBullet:function(x,y){context.fillRect(x,y,1,10)},move:function(){var allSurvivors=0;var lineSurvivors=0;var len=this.enemyArr.length;var lenDeep=CONFIG.numPerLine;var level,left,right,floor;for(var x=0;x<len;x++){for(var i=0;i<lenDeep;i++){if(this.enemyArr[x][i].isAlive){for(var j=lenDeep-1;j>=0;j--){if(this.enemyArr[x][j].isAlive){allSurvivors++;if(j+1-i>lineSurvivors){lineSurvivors=j+1-i;level=x;left=i;right=j}break}}floor=x;break}}}if(this.level===CONFIG.totalLevel&&!allSurvivors){GAME.allSuccess();return true}else if(!allSurvivors){GAME.success();return true}if(this.enemyArr[floor][left].y>CONFIG.enemyArea.height+CONFIG.canvasPadding){GAME.failed();return true}if(this.enemyDirection==="right"){this.x+=CONFIG.enemySpeed;if(this.enemyArr[level][right].x+50+30>canvas.width){this.y+=CONFIG.enemySize;this.enemyDirection="left"}}else{this.x-=CONFIG.enemySpeed;if(this.enemyArr[level][left].x<30){this.y+=CONFIG.enemySize;this.enemyDirection="right"}}},clearUI:function(){context.clearRect(0,0,canvas.width,canvas.height)},scored:function(){context.fillText("分数："+score,20,20,75,30)}};function checkBullet(x,y){for(var i=0;i<this.level;i++){GAMEUI.enemyArr[i].forEach(function(item){if(item.isAlive&&item.x+50>x&&item.x<x&&item.y+50>y&&item.y<y){item.isAlive=0;item.boomIndex=1;score+=1;cancelAnimationFrame(ani)}})}}function fire(){var x=GAMEUI.planeX+29;var y=GAMEUI.planeY-10;function bulletAnimation(){ani=requestAnimationFrame(bulletAnimation);if(checkBullet(x,y)||!y||GAME.status==="failed"||GAME.status==="all-success"||GAME.status==="success"){cancelAnimationFrame(ani)}else{GAMEUI.drawBullet(x,y);y-=CONFIG.bulletSpeed}}bulletAnimation()}function animate(){GAMEUI.clearUI();enemyAnimation=requestAnimationFrame(animate);if(!GAMEUI.move()){GAMEUI.scored();GAMEUI.drawEnemy();GAMEUI.drawPlane()}}GAME.init();